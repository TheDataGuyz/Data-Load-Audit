# Data Load Audit Framework

## 1. Introduction

Data is sent in files which are in JSON format. This involves the ingestion and transformation of JSON files into structured data, which is loaded into bronze schema, then to silver, and finally to gold schema.

## 2. Problem Statement

Currently, users have spotted issues where the gold records do not match the values in the SOURCE UI. This could be due to:
- The SOURCE not sending the reporting events,
- Transformation issues,
- Load issues between bronze and silver,
- Issues in silver to gold.

This framework is designed to track missing records and ensure data lineage from JSON to bronze, to silver, to gold.

## 3. Data Flow Overview and Analysis

### Table Schema

#### Bronze Layer

- **SOURCE_BATCH_ID**
  - Description: Contains the master list of all the batches generated by SOURCE.
  - Columns:
    - EXTRACT_DATE: Batch extraction datetime.
    - BATCH_ID: Unique identifier of a batch.

- **BATCH_EXTRACT**
  - Description: JSON files are loaded into this table.
  - Columns:
    - BATCH_ID: Unique identifier of a batch.
    - EXTRACT_DATE: Batch extraction datetime.
    - BATCH_JSON: JSON details of a batch.

- **ENTITY_EXTRACT**
  - Description: Contains transformed batches.
  - Columns:
    - ENTITYEVENT_ID: Unique identifier of a reportable entity event element.
    - SHAREDBATCHINFO_ID: Unique identifier of a shared batch info.
    - ENTITY: JSON details of an entity.
    - ACTIONS: JSON details of an action.
    - SHAREDBATCHINFO: JSON details of shared batch info.
    - TRANSFORMED_FLAG: Flag indicating if the record is transformed.
    - TRANSFORMED_TIMESTAMP: Transformation timestamp.

#### Silver Layer

- **STAGING_XXXX**
  - Description: Staging tables.
  - Columns:
    - BATCHID: Unique identifier of a batch.
    - ENTITYEVENT_ID: Unique identifier of a reportable entity event element.

- **BATCH_SHARED_INFO**
  - Description: Contains batch shared info.

- **ACTIONS_XXXX**
  - Description: Action tables.

#### Gold Layer

- **Gold Tables**
  - Description: Normalized tables.
  - Key columns as needed.

### Data Flow

#### JSON to Bronze
- Data is extracted from the SOURCE Data Pump (API) and loaded into the bronze layer.
- Tables Involved: `SOURCE_BATCH_ID`, `BATCH_EXTRACT`, `ENTITY_EXTRACT`.

#### Bronze to Silver
- Data is transformed and loaded from the bronze layer to the silver layer.
- Tables Involved: `ENTITY_EXTRACT` to staging tables.

#### Silver to Gold
- Data is loaded from the silver layer to the gold layer.
- Tables Involved: Staging tables to gold tables.

## 4. Audit Reconciliation Framework

This framework tracks missing records and ensures data lineage from JSON to bronze, to silver, to gold.

### Tables

1. **AUDIT_REFERENCE**
   - Description: Mapping reference of data lineage in bronze, silver, and gold layers.
   - Columns: REF_ID, REF_TYPE, SOURCE_OBJECT, SOURCE_COLUMN, DESTINATION_OBJECT, DESTINATION_COLUMN, CREATE_TIMESTAMP.

2. **AUDIT_JSON_TO_BRONZE**
   - Description: Shows count of batch IDs between tables on a daily basis.
   - Columns: AUDIT_ID, AUDIT_JOB_ID, SOURCE_EXTRACT_TIMESTAMP, SOURCE_BATCH_ID, BATCH_EXTRACT_BATCH_ID, ENTITY_EXTRACT_BATCH_ID, SOURCE_TO_BATCH_AUDIT_RESULT, BATCH_TO_ENTITY_AUDIT_RESULT, AUDIT_TIMESTAMP.

3. **AUDIT_DETAIL_JSON_TO_BRONZE**
   - Description: Shows missing batch IDs between tables.
   - Columns: AUDIT_ID, AUDIT_JOB_ID, SOURCE_EXTRACT_TIMESTAMP, SOURCE_BATCH_ID, BATCH_EXTRACT_BATCH_ID, ENTITY_EXTRACT_BATCH_ID, SOURCE_TO_BATCH_AUDIT_RESULT, BATCH_TO_ENTITY_AUDIT_RESULT, AUDIT_TIMESTAMP.

4. **AUDIT_BATCH_EVENT_BRONZE_TO_SILVER**
   - Description: Shows count of batch IDs and count of reporting event IDs between bronze and silver tables.
   - Columns: AUDIT_ID, AUDIT_JOB_ID, RAW_ENTITY_NAME, STAGING_TABLE_NAME, RAW_BATCH_ID, STAGING_BATCH_ID, RAW_ENTITY_EVENT_ELEMENT_ID, STAGING_ENTITY_EVENT_ELEMENT_ID, BATCH_ID_AUDIT_RESULT, ENTITY_EVENT_AUDIT_RESULT, AUDIT_TIMESTAMP.

5. **AUDIT_BATCH_EVENT_DETAIL_BRONZE_TO_SILVER**
   - Description: Shows missing batch IDs and reporting event IDs between bronze and silver tables.
   - Columns: AUDIT_ID, AUDIT_JOB_ID, RAW_ENTITY_NAME, STAGING_TABLE_NAME, RAW_BATCH_ID, STAGING_BATCH_ID, RAW_ENTITY_EVENT_ELEMENT_ID, STAGING_ENTITY_EVENT_ELEMENT_ID, BATCH_ID_AUDIT_RESULT, ENTITY_EVENT_AUDIT_RESULT, AUDIT_TIMESTAMP.

6. **AUDIT_PK_SILVER_TO_GOLD**
   - Description: Shows count of primary keys between silver and gold tables.
   - Columns: AUDIT_ID, AUDIT_JOB_ID, STG_TABLE_NAME, NORM_TABLE_NAME, STG_COLUMN_NAME, NORM_COLUMN_NAME, STG_ENTITY_COUNT, NORM_ENTITY_COUNT, COUNT_DIFF, AUDIT_RESULT, AUDIT_TIMESTAMP.

7. **AUDIT_ERROR_HANDLE_LOG**
   - Description: Logs errors encountered during the audit process.
   - Columns: ERROR_ID, AUDIT_ID, ERROR_MESSAGE, ERROR_TIMESTAMP.

8. **AUDIT_RUN_STATUS**
   - Description: Tracks the status of each audit run.
   - Columns: RUN_ID, AUDIT_ID, STATUS, START_TIME, END_TIME.

## 5. Benefits

- **Improved Data Quality**
  - By implementing data completeness checks, we can ensure that our data pipeline consistently delivers complete and accurate data, thereby enhancing overall data quality.

- **Enhanced Decision-Making**
  - Complete and reliable data is essential for making informed decisions. By ensuring data completeness, we empower stakeholders with trustworthy insights.

- **Mitigated Risks**
  - Identifying and addressing data completeness issues early mitigates the risk of making decisions based on incomplete or inaccurate data, thus safeguarding against potential business risks.
